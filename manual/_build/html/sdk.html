
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>SDKの使い方 &#8212; Hyperledger Fabric Manual 1.0 ドキュメント</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="prev" title="ピア追加のおおまかな流れ" href="addPeer.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="addPeer.html" title="ピア追加のおおまかな流れ"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Hyperledger Fabric Manual 1.0 ドキュメント</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="sdk">
<h1>SDKの使い方<a class="headerlink" href="#sdk" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="line-block">
<div class="line">ここではSDKの使い方を説明していく</div>
<div class="line">SDKにもいくつか種類があるがNode.js版を用いる</div>
</div>
<div class="section" id="id1">
<h2>前提条件<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<ul class="simple">
<li>Python2.7(npm installの際に3系だとエラーが出るため)</li>
<li>Node.js 6.9.x 以上だが、7.x未満</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<div class="last line-block">
<div class="line">Python3系と使い分けたい場合は、</div>
<div class="line">複数のPythonのバージョンを管理するツールであるpyenvあるいは、anyenv(さらにenv系ツールを管理するもの)をインストール</div>
</div>
</div>
<div class="section" id="anyenv">
<h3>anyenv導入方法<a class="headerlink" href="#anyenv" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>まずはインストール</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>git clone https://github.com/riywo/anyenv ~/.anyenv
</pre></div>
</div>
<div class="line-block">
<div class="line">次に、環境変数の設定</div>
<div class="line">これによってanyenvコマンドをターミナルから実行可能にする</div>
</div>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;export PATH=&quot;$HOME/.anyenv/bin:$PATH&quot;&#39;</span> &gt;&gt; ~/.your_profile
<span class="nb">echo</span> <span class="s1">&#39;eval &quot;$(anyenv init -)&quot;&#39;</span> &gt;&gt; ~/.your_profile
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<div class="last line-block">
<div class="line">your_profileの部分は、</div>
<div class="line">bashの場合は.bashrc or .bash_profile のどちらか</div>
<div class="line">zshの場合は.zshrc or .zprofile のどちらか</div>
</div>
</div>
<p>完了したらターミナルを再起動</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nb">exec</span> <span class="nv">$SHELL</span> -l
</pre></div>
</div>
<p>続いて、anyenv経由でのpyenvインストールおよびpyenvでのpythonインストール方法</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># pyenvのインストール</span>
anyenv install pyenv
<span class="c1"># python 3.6.1のインストール</span>
pyenv install <span class="m">3</span>.6.1
<span class="c1"># python 2.7のインストール</span>
pyenv install <span class="m">2</span>.7
<span class="c1"># 3.6.1をグローバル環境に変更</span>
pyenv global <span class="m">3</span>.6.1
</pre></div>
</div>
<p>2.7に変えたい場合は</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>pyenv global <span class="m">2</span>.7
</pre></div>
</div>
<p>pythonのインタープリタを起動したときにきちんと切り替わっているか確認する</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>$ python
Python <span class="m">3</span>.6.1 <span class="o">(</span>default, Jul <span class="m">12</span> <span class="m">2017</span>, <span class="m">18</span>:44:32<span class="o">)</span>
<span class="o">[</span>GCC <span class="m">4</span>.2.1 Compatible Apple LLVM <span class="m">8</span>.1.0 <span class="o">(</span>clang-802.0.42<span class="o">)]</span> on darwin
Type <span class="s2">&quot;help&quot;</span>, <span class="s2">&quot;copyright&quot;</span>, <span class="s2">&quot;credits&quot;</span> or <span class="s2">&quot;license&quot;</span> <span class="k">for</span> more information.
&gt;&gt;&gt;
</pre></div>
</div>
</div>
<div class="section" id="node-js">
<h3>Node.js導入方法<a class="headerlink" href="#node-js" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">6.9.xのものをインストールすればよい</div>
<div class="line">ただし7.xはサポートしていないので間違えないように</div>
<div class="line">くれぐれも最新版を落としてこないように気をつけてほしい</div>
</div>
<p>公式サイト(<a class="reference external" href="https://nodejs.org/en/download/releases/">https://nodejs.org/en/download/releases/</a>)</p>
<p>npmツールを最新版にするために以下コマンドを実行するが、Python2.7でないとコケるので注意</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>npm install npm@3.10.10 -g
</pre></div>
</div>
</div>
</div>
<div class="section" id="node-js-sdk">
<h2>Node.js SDKチュートリアル<a class="headerlink" href="#node-js-sdk" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><strong>本チュートリアルの目的</strong></p>
<p>基本的な機能である」query」と」update」をSDK経由で行えるようにする</p>
<div class="line-block">
<div class="line">サンプルは用意されており、fabric-samplesをクローンすればすぐに試すことができる</div>
<div class="line">このチュートリアルでは、3つのステップでアプリケーションの作り方(いじり方)を学んでいく</div>
</div>
<div class="line-block">
<div class="line">1. Hyperledger Fabricネットワークを立ち上げる</div>
<div class="line">台帳をqueryしたり、updateするには3つの基本の部品が必要</div>
<div class="line-block">
<div class="line-block">
<div class="line">・a peer node</div>
<div class="line">・ordering node</div>
<div class="line">・CA(Certificate Authority)</div>
</div>
<div class="line">この3つの部品がネットワークの根幹をなしている</div>
<div class="line">また、CLIコンテナを用いていくつかの管理コマンドを使うこともできる</div>
<div class="line">ネットワークは一つのスクリプトでダウンロードと起動ができる</div>
</div>
</div>
<div class="line-block">
<div class="line">2. サンプルのスマートコントラクトのパラメータを理解する</div>
<div class="line-block">
<div class="line">スマートコントラクトには様々な機能が含まれており、異なる方法で台帳と通信ができる</div>
</div>
</div>
<div class="line-block">
<div class="line">3. レコードをquery(参照)したり、update(更新)できるようにするためにアプリケーションに手を加える</div>
<div class="line-block">
<div class="line">アプリケーションではSDKのAPIを使うことで、ネットワークと通信し、最終的にはqueryやupdateといった機能を呼び出す</div>
</div>
</div>
<p><strong>テストネットワークを入手する</strong></p>
<p>以下コマンドで好きなところにサンプルをクローンし、fabcarディレクトリに移動</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>git clone https://github.com/hyperledger/fabric-samples.git
<span class="nb">cd</span> fabric-samples/fabcar
</pre></div>
</div>
<p>fabcarディレクトリには以下が存在する</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>&gt; chaincode    invoke.js       network         package.json    query.js        startFabric.sh
</pre></div>
</div>
<p>ネットワークを起動するためにstartFabric.shを実行する</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>./startFabric.sh
</pre></div>
</div>
<p>ここでなにをしているかを以下に簡単にまとめる</p>
<ul class="simple">
<li>a peer node, ordering node, CA, CLI Containerを起動</li>
<li>チャンネルを作成し、チャンネルにピアを追加する</li>
<li>ピアのファイルシステムにスマートコントラクトをインストールし、チャンネル上でチェーンコードと呼ばれるものをインスタンス化する</li>
<li>10台の車の情報を台帳に入れるためにinitLedger関数を呼び出す</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<div class="last line-block">
<div class="line">ここではCLIを用いてスクリプトのコマンドを実行しているが、SDKでもサポートしている</div>
<div class="line">興味があればリポジトリを参照(<a class="reference external" href="https://github.com/hyperledger/fabric-sdk-node">https://github.com/hyperledger/fabric-sdk-node</a>)</div>
</div>
</div>
<p>ここでdocker psコマンドを使うと、startFabric.shによって開始されたプロセス(コンテナの状況)を見ることができる</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>docker ps
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<div class="last line-block">
<div class="line"><strong>どのようにしてネットワークと通信するか</strong></div>
<div class="line">アプリケーションはスマートコントラクトを実行するためにAPIを用いる</div>
<div class="line">スマートコントラクトはネットワーク内でホストされ、名前やバージョンによって識別される</div>
<div class="line">例えば、ここでのチェーンコードコンテナは」dev-peer0.org1.example.com-fabcar-1.0」だが、</div>
<div class="line">名前はfabcar、バージョンは1.0、ピアはdev-peer0.org1.example.comに対して動いている</div>
</div>
</div>
<div class="section" id="query">
<h3>台帳をqueryする<a class="headerlink" href="#query" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">queryとは台帳からデータを読み込むことである</div>
<div class="line">単一のキーからも複数のキーからもqueryできる</div>
<div class="line">もし、台帳がJSONのようなリッチデータ・ストレージの形式で書かれている場合には、複雑な検索も可能</div>
<div class="line">先にも述べたように、サンプルネットワークにはアクティブなチェーンコードコンテナと10台の車データが用意された台帳が存在する</div>
<div class="line">また、fabcarディレクトリ内にはいくつかのJavascriptコードもある</div>
<div class="line">query.jsは車の詳細に対して検索を可能にする</div>
</div>
<p>まず、SDK nodeモジュールをプログラム内で機能させるために以下コマンドでインストールする</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>npm install
</pre></div>
</div>
<p>これでjavascriptプログラムを動かせるようになった
それでは、query.jsを実行して台帳からすべての車のリストを返してもらう</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>node query.js
</pre></div>
</div>
<div class="highlight-shell"><div class="highlight"><pre><span></span>Query result <span class="nv">count</span> <span class="o">=</span>  <span class="m">1</span>
Response is  <span class="o">[{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR0&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;blue&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Toyota&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Prius&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Tomoko&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR1&quot;</span>,   <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;red&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Ford&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Mustang&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Brad&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR2&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;green&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Hyundai&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Tucson&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Jin Soo&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR3&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;yellow&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Volkswagen&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Passat&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Max&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR4&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;black&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Tesla&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;S&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Adriana&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR5&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;purple&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Peugeot&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;205&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Michel&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR6&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;white&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Chery&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;S22L&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Aarav&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR7&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;violet&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Fiat&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Punto&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Pari&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR8&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;indigo&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Tata&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Nano&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Valeria&quot;</span><span class="o">}}</span>,
<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;CAR9&quot;</span>, <span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;brown&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Holden&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Barina&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Shotaro&quot;</span><span class="o">}}]</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">これが返ってくる</div>
<div class="line">台帳はkey/valueベースになっていることがわかる</div>
</div>
<p>ここでエディタを使ってquery.jsの中身を見がてら、内容を少し変えてみる</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">wallet_path</span> <span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;./network/creds&#39;</span><span class="p">),</span>
      <span class="nx">user_id</span><span class="o">:</span> <span class="s1">&#39;PeerAdmin&#39;</span><span class="p">,</span>
      <span class="nx">channel_id</span><span class="o">:</span> <span class="s1">&#39;mychannel&#39;</span><span class="p">,</span>
      <span class="nx">chaincode_id</span><span class="o">:</span> <span class="s1">&#39;fabcar&#39;</span><span class="p">,</span>
      <span class="nx">network_url</span><span class="o">:</span> <span class="s1">&#39;grpc://localhost:7051&#39;</span><span class="p">,</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">最初のセクションはこうなっている</div>
<div class="line">ここではchaincode ID、channel name、network endpointsといったいくつかの変数が定義されている</div>
</div>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="c1">// queryCar - requires 1 argument, ex: args: [&#39;CAR4&#39;],</span>
<span class="c1">// queryAllCars - requires no arguments , ex: args: [&#39;&#39;],</span>
<span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
   <span class="nx">chaincodeId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chaincode_id</span><span class="p">,</span>
   <span class="nx">txId</span><span class="o">:</span> <span class="nx">transaction_id</span><span class="p">,</span>
   <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;queryAllCars&#39;</span><span class="p">,</span>
   <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">ここでchaincode_idをfabncarとして定義している(これによって特定のchaincodeをターゲットにすることを許している)</div>
<div class="line">そして、このチェーンコード内で定義されたqueryAllCars関数が呼ばれることになっている</div>
<div class="line">しかし、わたしたちが使える関数はこれだけではない</div>
<div class="line">chaincodeディレクトリ内のfabcar.goをエディタで開く</div>
<div class="line">するとそこには、initLedger, queryCar, queryAllCars, createCar, changeCarOwnerといった関数が用意されているのがわかる</div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">SmartContract</span><span class="p">)</span> <span class="nx">queryAllCars</span><span class="p">(</span><span class="nx">APIstub</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">ChaincodeStubInterface</span><span class="p">)</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>

     <span class="nx">startKey</span> <span class="o">:=</span> <span class="s">&quot;CAR0&quot;</span>
     <span class="nx">endKey</span> <span class="o">:=</span> <span class="s">&quot;CAR999&quot;</span>

     <span class="nx">resultsIterator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">APIstub</span><span class="p">.</span><span class="nx">GetStateByRange</span><span class="p">(</span><span class="nx">startKey</span><span class="p">,</span> <span class="nx">endKey</span><span class="p">)</span>
</pre></div>
</div>
<p>このqueryAllCars関数ではshimインターフェースのGetStateByRange関数を用いることで、引数のstartKeyとendKeyの間の台帳データを返してくれることがわかった</p>
<p>それではまたquery.jsに戻り、コードを少し変更してみる
fcn:で定義されているqueryAllCarsをqueryCarに変え、keyとして用いる引数の部分をCAR4に変える</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">chaincodeId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chaincode_id</span><span class="p">,</span>
      <span class="nx">txId</span><span class="o">:</span> <span class="nx">transaction_id</span><span class="p">,</span>
      <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;queryCar&#39;</span><span class="p">,</span>
      <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CAR4&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>保存したらfabcarディレクトリに戻り、以下コマンドで再度実行</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>&gt; node query.js

<span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;black&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Tesla&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;S&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Adriana&quot;</span><span class="o">}</span> //結果
</pre></div>
</div>
<p>引数を変えればいろんな検索が可能である</p>
</div>
<div class="section" id="update">
<h3>台帳をupdateする<a class="headerlink" href="#update" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>次に台帳を更新していく</p>
<div class="line-block">
<div class="line">台帳の更新はtransaction proposalを生成するアプリケーションとともに始まる</div>
<div class="line">queryのとき同様に、リクエストはchannel ID、関数、特定のスマートコントラクトを識別するために構成されている</div>
<div class="line">そこでプログラムは承認用にピアに向けてtransaction proposalを送るために、channel.SendTransactionProposal APIを呼ぶ</div>
<div class="line">ネットワークはアプリケーションがトランザクション要求をビルドし、署名するために用いるproposal responseを返す</div>
<div class="line">リクエストはchannel.sendTransaction APIを呼ぶことでordering serviceに送られる</div>
<div class="line">ordering serviceはブロックの内部にトランザクションを組み込んでいく</div>
<div class="line">そして、validation用にチェンネル上のすべてのピアに向けてブロックを配達する</div>
<div class="line">最終的にアプリケーションはピアのイベントリスナーポートへ接続するためにeh.setPeerAddr APIを使い、特定のトランザクションIDと結びついているイベントを登録するためにeh.registerTxEventを呼ぶ</div>
<div class="line">このAPIはトランザクションの行方を知ることをアプリケーションに許可する</div>
<div class="line">通知のメカニズムだと思えばよい</div>
</div>
<div class="line-block">
<div class="line">それでは、新しく車を作成する</div>
<div class="line">invoke.jsをエディタで開く</div>
</div>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="c1">// createCar - requires 5 args, ex: args: [&#39;CAR11&#39;, &#39;Honda&#39;, &#39;Accord&#39;, &#39;Black&#39;, &#39;Tom&#39;],</span>
<span class="c1">// changeCarOwner - requires 2 args , ex: args: [&#39;CAR10&#39;, &#39;Barry&#39;],</span>
<span class="c1">// send proposal to endorser</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">targets</span><span class="o">:</span> <span class="nx">targets</span><span class="p">,</span>
    <span class="nx">chaincodeId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chaincode_id</span><span class="p">,</span>
    <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span>
    <span class="nx">chainId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">channel_id</span><span class="p">,</span>
    <span class="nx">txId</span><span class="o">:</span> <span class="nx">tx_id</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">ここには2つの関数があることがわかる</div>
<div class="line">- createCar</div>
<div class="line">- changeCarOwner</div>
</div>
<div class="line-block">
<div class="line">これからredで車種はChevy Volt、所有者はNickの車を作成する</div>
<div class="line">CAR9までは存在するのでCAR10をkeyとする</div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">targets</span><span class="o">:</span> <span class="nx">targets</span><span class="p">,</span>
    <span class="nx">chaincodeId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chaincode_id</span><span class="p">,</span>
    <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;createCar&#39;</span><span class="p">,</span>
    <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CAR10&#39;</span><span class="p">,</span> <span class="s1">&#39;Chevy&#39;</span><span class="p">,</span> <span class="s1">&#39;Volt&#39;</span><span class="p">,</span> <span class="s1">&#39;Red&#39;</span><span class="p">,</span> <span class="s1">&#39;Nick&#39;</span><span class="p">],</span>
    <span class="nx">chainId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">channel_id</span><span class="p">,</span>
    <span class="nx">txId</span><span class="o">:</span> <span class="nx">tx_id</span>
</pre></div>
</div>
<p>保存して実行する</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>&gt; node invoke.js

&gt; The transaction has been committed on peer localhost:7053 //結果
</pre></div>
</div>
<p>ピアはイベント通知を送ってきている
アプリケーションがこの通知を受け取れるのはさきほど紹介したeh.registerTxEvent APIのおかげだ</p>
<p>ここで本当にCAR10が作成されているか調べるためにquery.jsの引数をCAR10に変更して実行する</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>&gt; <span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;Red&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Chevy&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Volt&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Nick&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>これが返ってくれば成功</p>
<p>最後に、所有者の名前を変更してみる</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
   <span class="nx">targets</span><span class="o">:</span> <span class="nx">targets</span><span class="p">,</span>
   <span class="nx">chaincodeId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chaincode_id</span><span class="p">,</span>
   <span class="nx">fcn</span><span class="o">:</span> <span class="s1">&#39;changeCarOwner&#39;</span><span class="p">,</span>
   <span class="nx">args</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;CAR10&#39;</span><span class="p">,</span> <span class="s1">&#39;Barry&#39;</span><span class="p">],</span>
   <span class="nx">chainId</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">channel_id</span><span class="p">,</span>
   <span class="nx">txId</span><span class="o">:</span> <span class="nx">tx_id</span>
</pre></div>
</div>
<p>と変更し、再度実行</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>&gt; node invoke.js
&gt; <span class="o">{</span><span class="s2">&quot;colour&quot;</span>:<span class="s2">&quot;Red&quot;</span>,<span class="s2">&quot;make&quot;</span>:<span class="s2">&quot;Chevy&quot;</span>,<span class="s2">&quot;model&quot;</span>:<span class="s2">&quot;Volt&quot;</span>,<span class="s2">&quot;owner&quot;</span>:<span class="s2">&quot;Barry&quot;</span><span class="o">}</span>　//結果
</pre></div>
</div>
<p>以上でチュートリアルは終了する</p>
</div>
</div>
</div>
<div class="section" id="id2">
<h1>本番SDKの使い方<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>Orionで用いているSDKについて説明する</p>
<div class="line-block">
<div class="line">OrionではWebアプリからのリクエストに呼応するようになっている</div>
<div class="line">app.jsというファイルにて8000番ポートからのリクエストを受け付けている</div>
</div>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">queryAll</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/queryAll&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">initDist</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/initDist&#39;</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;body-parser&#39;</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span>
  <span class="nx">extended</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Example app listening on port 8000!&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">OrionではExpressというNode.js向けのWebフレームワークを使用している</div>
<div class="line">日本語のドキュメントも出ているので詳しく知りたい場合は <a class="reference external" href="http://expressjs.com/ja/">こちら</a></div>
<div class="line">app.jsを実行すると、8000番からのリクエストを受け付けるようになる</div>
</div>
<div class="highlight-shell"><div class="highlight"><pre><span></span>% node app.js
&gt; Example app listening on port <span class="m">8000</span>!
</pre></div>
</div>
<p>ここでqueryAllしたい場合はcurlでGETメソッドを用いて、queryAll関数を呼び出す</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>% curl -X GET http://localhost:8000/queryAll
&gt; <span class="o">[{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;LIMIT&quot;</span>,<span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;limit&quot;</span>:<span class="s2">&quot;1966-12-09T23:59:00Z&quot;</span><span class="o">}}</span>,<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;MAX&quot;</span>,<span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;max&quot;</span>:0<span class="o">}}</span>,<span class="o">{</span><span class="s2">&quot;Key&quot;</span>:<span class="s2">&quot;USR-1&quot;</span>,<span class="s2">&quot;Record&quot;</span>:<span class="o">{</span><span class="s2">&quot;auth&quot;</span>:0,<span class="s2">&quot;coin&quot;</span>:0,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;raw&quot;</span>:0<span class="o">}}]</span>
</pre></div>
</div>
<p>上記のcurlコマンドはapp.js内で以下の関数で処理される</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>app.get<span class="o">(</span><span class="s1">&#39;/queryAll&#39;</span>, <span class="k">function</span><span class="o">(</span>req, res<span class="o">)</span> <span class="o">{</span>
  queryAll.run<span class="o">((</span>ret<span class="o">)</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nv">ret</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">{</span>
      res.send<span class="o">(</span><span class="s2">&quot;null&quot;</span><span class="o">)</span><span class="p">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      res.json<span class="o">(</span>JSON.parse<span class="o">(</span>ret<span class="o">))</span><span class="p">;</span>
    <span class="o">}</span>
  <span class="o">})</span><span class="p">;</span>
<span class="o">})</span><span class="p">;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">queryAll.run()でqueryAllオブジェクトのrun()メソッドが実行される</div>
<div class="line">この場合は、./lib/queryAllが実行される(node queryAll.jsしたのと実質同等)</div>
</div>
<p>初期配布をしたい場合は、</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>% curl -X POST http://localhost:8000/initDist -d <span class="s1">&#39;max=1000&amp;limit=&#39;</span><span class="m">2017</span>-12-31<span class="s1">&#39;&#39;</span>
&gt; <span class="o">{</span><span class="s2">&quot;result&quot;</span>:true,<span class="s2">&quot;msg&quot;</span>:<span class="s2">&quot;3733e78e5e66decee2f84eba7a6dfef8b9373fca8c07a48787b5e4d47dbdb842&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>POSTメソッドで呼び出し、引数を与える</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/initDist&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// リクエストボディを出力</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">max</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">limit</span><span class="p">]</span>
    <span class="nx">initDist</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">params</span><span class="p">,(</span><span class="nx">ret</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">})</span>
</pre></div>
</div>
<p>この時注意してほしいのは、var params = [req.body.max,req.body.limit]へ引数を渡すために</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;max=1000&amp;limit=&#39;</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>という表記をしている点である</p>
<p>引数を複数渡す場合は、key=value&amp;key=valueという書き方をする</p>
<p>本番SDKの使い方は以上</p>
</div>
<div class="section" id="id4">
<h1>チェーンコード<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="line-block">
<div class="line">チェーンコードはGo言語で書かれている</div>
<div class="line">チェーンコードはピアがどのような動きをするか(関数)定義し、データ構造を決定する根幹部分にあたる</div>
<div class="line">SDKではこのチェーンコードへアクセスして、関数を呼び出している</div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">UserInfo</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="c1">// ユーザー名</span>
<span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&quot;name&quot;`</span>
<span class="c1">// １次配布用コイン</span>
<span class="nx">Raw</span> <span class="kt">int64</span> <span class="s">`json:&quot;raw&quot;`</span>
<span class="c1">//　決済可能な有効コイン</span>
<span class="nx">Coin</span> <span class="kt">int64</span> <span class="s">`json:&quot;coin&quot;`</span>
<span class="c1">// 権限情報</span>
<span class="nx">Auth</span> <span class="kt">uint64</span> <span class="s">`json:&quot;auth&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">ここではユーザー情報に関する構造体を定義している</div>
<div class="line">Go言語は逆ポーランド記法なので変数名を先に宣言してから型を宣言する</div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="s">`json:&quot;name&quot;`</span>
</pre></div>
</div>
<p>はjson表記する際の記法なので特にここでは触れない</p>
<div class="line-block">
<div class="line">実際にqueryAllがどのような流れで行われるかを説明する</div>
<div class="line">SDKあるいはcliを通してチェーンコードへのアクセスがあると、まずはInvokeが呼ばれる</div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">//呼ぶ関数を決定するために、ここで引数を検証する。基本機能のインデックスのようなもの。</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">SmartContract</span><span class="p">)</span> <span class="nx">Invoke</span><span class="p">(</span><span class="nx">APIstub</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">ChaincodeStubInterface</span><span class="p">)</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>

<span class="c1">// スマートコントラクトの関数名と引数を受け取る</span>
<span class="nx">function</span><span class="p">,</span> <span class="nx">args</span> <span class="o">:=</span> <span class="nx">APIstub</span><span class="p">.</span><span class="nx">GetFunctionAndParameters</span><span class="p">()</span>
<span class="c1">// Route to the appropriate handler function to interact with the ledger appropriately</span>
<span class="c1">//以下に関数名ごとの処理先を明示</span>
<span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;initLedger&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">initLedger</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;queryUser&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">queryUser</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;queryAll&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">queryAll</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;queryMax&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">queryMax</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;queryLimit&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">queryLimit</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;createUser&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">createUser</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;addRaw&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">addRaw</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;changeAuth&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">changeAuth</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;changeMax&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">changeMax</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;sendTbc&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">sendTbc</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;initDist&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">initDist</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;modifyLimit&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">modifyLimit</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">function</span> <span class="o">==</span> <span class="s">&quot;initializer&quot;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">initializer</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;無効なスマートコントラクト名です&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">APIstub.GetFunctionAndParameters()で引数として渡された関数名と引数をそれぞれfunctionとargsに入れる</div>
<div class="line">そして、function名とマッチする関数を探して、一致したらその関数を呼び出す</div>
<div class="line">functionがqueryAllならs.queryAll(APIstub)が呼ばれる</div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">//全台帳参照</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">SmartContract</span><span class="p">)</span> <span class="nx">queryAll</span><span class="p">(</span><span class="nx">APIstub</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">ChaincodeStubInterface</span><span class="p">)</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>
      <span class="nx">startKey</span> <span class="o">:=</span> <span class="s">&quot;&quot;</span>
      <span class="nx">endKey</span> <span class="o">:=</span> <span class="s">&quot;&quot;</span>

      <span class="nx">resultsIterator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">APIstub</span><span class="p">.</span><span class="nx">GetStateByRange</span><span class="p">(</span><span class="nx">startKey</span><span class="p">,</span> <span class="nx">endKey</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
      <span class="p">}</span>
      <span class="k">defer</span> <span class="nx">resultsIterator</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

      <span class="c1">// bufferは参照結果を含むJSON配列</span>
      <span class="kd">var</span> <span class="nx">buffer</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
      <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="p">)</span>

      <span class="nx">bArrayMemberAlreadyWritten</span> <span class="o">:=</span> <span class="kc">false</span>
      <span class="k">for</span> <span class="nx">resultsIterator</span><span class="p">.</span><span class="nx">HasNext</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">queryResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resultsIterator</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span>
              <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
              <span class="p">}</span>
              <span class="c1">// 配列内を&quot;,&quot;で区切っている</span>
              <span class="c1">//Add a comma before array members, suppress it for the first array member</span>
              <span class="k">if</span> <span class="nx">bArrayMemberAlreadyWritten</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
                      <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
              <span class="p">}</span>
              <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;{\&quot;Key\&quot;:&quot;</span><span class="p">)</span>
              <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;\&quot;&quot;</span><span class="p">)</span>
              <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nx">queryResponse</span><span class="p">.</span><span class="nx">Key</span><span class="p">)</span>
              <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;\&quot;&quot;</span><span class="p">)</span>

              <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;, \&quot;Record\&quot;:&quot;</span><span class="p">)</span>
              <span class="c1">//レコードはJSONオブジェクト。なのでそのまま書く。</span>
              <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">queryResponse</span><span class="p">.</span><span class="nx">Value</span><span class="p">))</span>
              <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;}&quot;</span><span class="p">)</span>
              <span class="nx">bArrayMemberAlreadyWritten</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      <span class="nx">buffer</span><span class="p">.</span><span class="nx">WriteString</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">)</span>

      <span class="c1">//デバッグ</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;- queryAll:\n%s\n&quot;</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>

      <span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Success</span><span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">queryAllで実行されているのは、APIstub.GetStateByRange(startKey, endKey)</div>
<div class="line">startKeyからendKeyまでのデータを取ってくるというものだが、なにもいれないと台帳のデータをまるごと取得できる</div>
<div class="line">取得したデータをresultsIteratorに入れたのちに、文字列を追加してJSON形式に編集しているが本筋でないのでここでは説明しない</div>
</div>
<div class="line-block">
<div class="line">次にinitDistについて説明する</div>
<div class="line">この関数は初期配布時にadminユーザーであるUSR-1のRawコイン(P)を増やし、その分だけ最大発行額も設定し、有効期限も決定する</div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span></span><span class="c1">//配布準備時</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">SmartContract</span><span class="p">)</span> <span class="nx">initDist</span><span class="p">(</span><span class="nx">APIstub</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">ChaincodeStubInterface</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;引数の数は2つです&quot;</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">//増額は正の整数、減額は負の整数</span>
      <span class="nx">max</span> <span class="o">:=</span> <span class="nx">Max</span><span class="p">{}</span>
      <span class="nx">init</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseUint</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
      <span class="p">}</span>
      <span class="nx">max</span><span class="p">.</span><span class="nx">Max</span> <span class="p">=</span> <span class="nx">init</span>

      <span class="nx">maxAsBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
      <span class="p">}</span>
      <span class="nx">APIstub</span><span class="p">.</span><span class="nx">PutState</span><span class="p">(</span><span class="s">&quot;MAX&quot;</span><span class="p">,</span> <span class="nx">maxAsBytes</span><span class="p">)</span>

      <span class="c1">//有効期限の初期化</span>
      <span class="nx">input</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">modifyLimit</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>

      <span class="c1">//中央銀行に発行額を送る</span>
      <span class="nx">addraw</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;USR-1&quot;</span><span class="p">,</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">addRaw</span><span class="p">(</span><span class="nx">APIstub</span><span class="p">,</span> <span class="nx">addraw</span><span class="p">)</span>

      <span class="k">return</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">Success</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">変数maxを構造体Maxで初期化</div>
<div class="line">引数の1番目をstrconv.ParseUint(args[0], 10, 0)でUint型に変換してinitに代入</div>
<div class="line">そしてinitをMax構造体内に代入し、json.Marshal(max)でByte型に変換して、maxAsBytesに代入</div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">APIstub</span><span class="o">.</span><span class="n">PutState</span><span class="p">(</span><span class="s2">&quot;MAX&quot;</span><span class="p">,</span> <span class="n">maxAsBytes</span><span class="p">)</span>
</pre></div>
</div>
<p>でKeyをMAXとして、maxAsBytesをValueとして台帳に保存している</p>
<p>補足だが、台帳からKeyを元にして呼び出す際はGetState()を使う</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>前のトピックへ</h4>
  <p class="topless"><a href="addPeer.html"
                        title="前の章へ">ピア追加のおおまかな流れ</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="検索" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="addPeer.html" title="ピア追加のおおまかな流れ"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Hyperledger Fabric Manual 1.0 ドキュメント</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, r-tominaga.
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5 で生成しました。
    </div>
  </body>
</html>